<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gráficos da Pesquisa</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Resultados da Pesquisa</h1>
    <p>Resumo das respostas armazenadas no banco de dados.</p>
  </header>

  <main class="container">
    <canvas id="graficoGeral"></canvas>
    <div id="textoResumo" style="margin-top:20px; text-align:center;"></div>
  </main>

  <footer>
    <a href="index.html">Voltar à pesquisa</a>
  </footer>

  <script>
    fetch("buscar_respostas.php")
      .then(res => res.json())
      .then(respostas => {
        if (respostas.length === 0) {
          document.getElementById("textoResumo").innerText = "Nenhuma resposta enviada ainda.";
          return;
        }

        const opcoes = ["Muito Insatisfeito", "Insatisfeito", "Neutro", "Satisfeito", "Muito Satisfeito"];
        const contagem = Array(6).fill(0).map(() => [0,0,0,0,0]);

        respostas.forEach(r => {
          for (let i=1; i<=6; i++){
            const idx = opcoes.indexOf(r[`p${i}`]);
            if (idx >= 0) contagem[i-1][idx]++;
          }
        });

        const medias = contagem.map(p => {
          const total = p.reduce((a,b)=>a+b,0);
          const peso = p.reduce((a,b,i)=>a+b*(i+1),0);
          return total ? (peso / (total*5))*100 : 0;
        });

        const mediaGeral = Math.round(medias.reduce((a,b)=>a+b,0)/6);
        document.getElementById("textoResumo").innerText = `${mediaGeral}% das pessoas estão satisfeitas.`;

        new Chart(document.getElementById("graficoGeral"), {
          type: 'bar',
          data: {
            labels: ['Pergunta 1','Pergunta 2','Pergunta 3','Pergunta 4','Pergunta 5','Pergunta 6'],
            datasets: [{
              label: '% de Satisfação Média',
              data: medias,
              backgroundColor: 'rgba(46, 204, 113, 0.7)',
              borderColor: 'rgba(39, 174, 96, 1)',
              borderWidth: 2
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, max: 100, title: { display: true, text: '% Satisfação' } }
            }
          }
        });
      })
      .catch(() => {
        document.getElementById("textoResumo").innerText = "Erro ao carregar os dados do servidor.";
      });
  </script>
</body>
</html>
